<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://mattconn.github.io/favicon.ico><link rel=stylesheet href=https://mattconn.github.io/css/style.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script type=text/x-mathjax-config>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ["\\(", "\\)"]],
      processEscapes: true,
    }
  }
</script><title>Compiling an SDL2 Game to WASM</title><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><header id=banner><h2><a href=https://mattconn.github.io>MattConn</a></h2><nav><ul><li><a href=https://mattconn.github.io/ title>Home</a></li><li><a href=https://mattconn.github.io/projects title>Projects</a></li><li><a href=https://github.com/mattConn title>GitHub</a></li><li><a href=https://docs.google.com/document/d/1xpLTFJak9plpU-bo0I6GRmdDIijkfauvG1_zgg2dopc/edit title>Resume</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Compiling an SDL2 Game to WASM</h1><time>July 13, 2020</time></header><p><img src=https://mattconn.github.io/images/snake.png alt></p><p>I have a Snake clone written in C++ and SDL2, and while it&rsquo;s not just-add-water (yet) to compile a game to WASM with emscripten, it&rsquo;s pretty close. There was just some minor refactoring to be done, but it didn&rsquo;t affect the desktop version.</p><h1 id=infinite-loop-error>Infinite loop error</h1><p>My game loop spins forever or until a quit event occurs. Infinite loops don&rsquo;t fly in the browser however, and this is the biggest change that had to be made to my game.</p><p>I had to move some code around, and what once sat in a while loop now lives in a function.</p><p>Before (no good):</p><pre tabindex=0><code>// main.cpp

int main()
{
	&lt;init code...&gt;

	while(running)
	{
		&lt;game loop code...&gt;
	}

	return 0;
}
</code></pre><p>After (good):</p><pre tabindex=0><code>// main.cpp

&lt;declarations, defined later during init...&gt;

void mainloop()
{
	&lt;game loop code...&gt;

	if(quit)
	{
		emscripten_cancel_main_loop(); 
		// ^ Add this to your close and destroy code 
		&lt;close sdl subsystems and destroy...&gt;
	}
}

int main()
{
	&lt;init code...&gt;

	emscripten_set_main_loop(mainloop, 0, 1);

	return 0;
}
</code></pre><p>My main routine now ends with the <code>emscripten_set_main_loop</code> call, whereas prior to this WASM refactor, it ended with a closing of SDL2 subsystems, meaning my game now handles quitting at the end of the game loop.</p><p>Later on I&rsquo;ll add define guards to make sure this all still compiles for desktop.</p><h1 id=build-flags>Build Flags</h1><p>There were some build troubles. To be fair, I didn&rsquo;t read all that much on what these build flags mean, but that&rsquo;s alright because it builds now and that&rsquo;s all that matters (just kidding). It does build though.</p><h3 id=runtimeerror-error-unreachable><code>RuntimeError error: unreachable</code></h3><p>A Google search led to a suggestion that this resulted from control flow not being able to reach code due to a missing return statement? I then tracked it down to a SDL_RenderPresent call. I&rsquo;m wrapping most SDL things in my own namespace and functions so I though that might be the problem. It turns out it was the <code>asyncify</code> flag which I thoughtlessly and needlessly added to the build flags.</p><p>Bad:</p><pre tabindex=0><code>em++ *.cpp -o snake.html -g -lm --bind -s USE_SDL=2 -s USE_SDL_IMAGE=2 -s SDL2_IMAGE_FORMATS=&#39;[&#34;png&#34;]&#39; --preload-file assets/ --use-preload-plugins -s ASYNCIFY
</code></pre><p>Good:</p><pre tabindex=0><code>em++ *.cpp -o snake.html -g -lm --bind -s USE_SDL=2 -s USE_SDL_IMAGE=2 -s SDL2_IMAGE_FORMATS=&#39;[&#34;png&#34;]&#39; --preload-file assets/ --use-preload-plugins
</code></pre><p>No asyncify.</p><h3 id=handling-images>Handling Images</h3><p><code>-s SDL2_IMAGE_FORMATS='["png"]' --preload-file assets/ --use-preload-plugins</code></p><p>These flags will let SDL2_image load PNG&rsquo;s. Also, a trailing slash must be used to preload an entire directory with <code>preload-file</code>.</p><h1 id=maintaining-interoperability>Maintaining Interoperability</h1><p>Makefile targets look like this, snake-game being for desktop and snake.html for wasm:</p><pre tabindex=0><code>snake-game: *.cpp
        clang++ -std=c++11 -I /usr/include/SDL2/ -l SDL2 -l SDL2_image $^ -o $@

snake.html: *.cpp
        em++ $^ -o $@ -g -lm --bind -s USE_SDL=2 -s USE_SDL_IMAGE=2 -s SDL2_IMAGE_FORMATS=&#39;[&#34;png&#34;]&#39; --preload-file assets/ --use-preload-plugins 
</code></pre><p>I also added define guards around emscripten function calls and the header as well.
At the top of main.cpp:</p><pre tabindex=0><code>.
.
.

#ifdef __EMSCRIPTEN__
#include &#34;emscripten.h&#34;
#endif

.
.
.
</code></pre><p>and, towards the end of mainloop():</p><pre tabindex=0><code>.
.
.

if(quit) {
	#ifdef __EMSCRIPTEN__
	emscripten_cancel_main_loop();
	#endif

	&lt;close SDL subsystems and destroy...&gt;
}

.
.
.
</code></pre><p>and at the bottom of main():</p><pre tabindex=0><code>.
.
.

        #ifdef __EMSCRIPTEN__
        emscripten_set_main_loop(mainloop, 0, 1);
        #endif

        #ifndef __EMSCRIPTEN__
	// repeatedly calling mainloop on desktop
        while(!quit) mainloop();
        #endif

        return 0;
}
</code></pre><h1 id=game-development-with-wasm-in-mind>Game Development with WASM in Mind</h1><p>I will probably separate my code like the above in the future to keep it open for WASM compilation, much like we now develop webpages mobile-first.</p><p>If you&rsquo;ve made it this far, you&rsquo;d may as well play my Snake clone here: <a href=http://mattconndev.com/snake-wasm/ target=_blank>http://mattconndev.com/snake-wasm/</a></p><h1 id=sources>Sources</h1><p>Code restructuring for emscripten: <a href=https://medium.com/@robaboukhalil/porting-games-to-the-web-with-webassembly-70d598e1a3ec target=_blank>https://medium.com/@robaboukhalil/porting-games-to-the-web-with-webassembly-70d598e1a3ec</a></p><p>Define guards for interoperability: <a href=https://dev.to/kibebr/i-made-a-game-in-c-run-in-a-web-browser-and-so-can-you-4deb target=_blank>https://dev.to/kibebr/i-made-a-game-in-c-run-in-a-web-browser-and-so-can-you-4deb</a></p></article></main><footer id=footer></footer></body></html>